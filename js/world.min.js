
var distance=function(x1,y1,x2,y2){return Math.sqrt(Math.abs(Math.pow(x1-x2,2))+Math.abs(Math.pow(y1-y2,2)));};var Planet=function(opt){opt=opt||{};this._id=opt._id||'home';this._x=opt._x||0;this._y=opt._y||0;this._size=opt._size||60;this._starPort=opt._starPort===undefined?true:opt._starPort;this._ore=opt._ore||10;this._oreMax=10;this._oreRate=3000;this._lastUpdate=new Date();};Planet.prototype.SPCost=function(){var d=Math.floor(distance(0,0,this._x,this._y));return d;};var World=(function(){var status={vpw:640,vph:480,money:1000,d:0,planets:[],selectedPlanet:{},onPlanet:function(){var i=this.planets.length,p,d;while(i--){p=this.planets[i];if(distance(this.vpx+this.ship.x,this.vpy+this.ship.y,p._x,p._y)<=p._size){return p;}}
return false;},genRim:function(pc,d){var pl,r,p=0;pc=pc||50;d=d||1000;while(p<pc){r=Math.PI/(pc/2)*p;pl=new Planet({_id:'rim_d'+d+'_'+p,_x:Math.cos(r)*d,_y:Math.sin(r)*d,_size:30,_ore:0,_starPort:false});this.planets.push(pl);p+=1;}},genPlanets:function(){this.planets=[];this.planets.push(new Planet());this.genRim(30,1000);this.genRim(120,10000);},ship:{heading:25,speed:5,x:0,y:0,ore:0,maxOre:40,setHome:function(){status.vpx=0-status.vpw/2;status.vpy=0-status.vph/2;this.heading=25;this.speed=0;this.x=status.vpw/2;this.y=status.vph/2;},loadOre:function(oreAmount,cb){if(this.ore+oreAmount<this.maxOre){this.ore+=oreAmount;cb();}},headingChange:function(down){if(down){this.heading-=1;}else{this.heading+=1;}
if(this.heading<0){this.heading=99;}
if(this.heading>100){this.heading=0;}},speedChange:function(down){if(down){this.speed-=1;}else{this.speed+=1;}
if(this.speed>=21){this.speed=20;}
if(this.speed<=0){this.speed=0;}}},update:function(){var radian=Math.PI/50*this.ship.heading;this.d=distance(this.vpx+this.ship.x,this.vpy+this.ship.y,0,0);this.vpx+=Math.cos(radian)*this.ship.speed;this.vpy+=Math.sin(radian)*this.ship.speed;var self=this;this.planets.forEach(function(p){var d=distance(self.vpx+self.ship.x,self.vpy+self.ship.y,p._x,p._y);if(d<500){api.updatePlanet(p);}});}};var api={newGame:function(){status.genPlanets();status.ship.setHome();},buy:function(what){var p=status.selectedPlanet;switch(what){case'sp':var cost=p.SPCost();if(status.money>=cost){status.money-=cost;p._lastUpdate=new Date();p._starPort=true;}
break;}},update:status.update.bind(status),updatePlanet:function(p){p=p===undefined?status.selectedPlanet:p;var now=new Date,t=now-p._lastUpdate,deltaOre;if(p._starPort){if(t>p._oreRate){if(p._id=='home'){if(p._ore>0){p._ore-=1;status.money+=100;}}else{deltaOre=Math.floor(t/p._oreRate);if(deltaOre+p._ore>p._oreMax){p._ore=p._oreMax;}else{p._ore+=deltaOre;}}
p._lastUpdate=new Date();}}},getStatus:function(){return status;}};api.newGame();return api;}
());